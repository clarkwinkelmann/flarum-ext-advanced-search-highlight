(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};(()=>{"use strict";t.r(e);const r=flarum.core.compat["common/extend"],n=flarum.core.compat["forum/app"];var o=t.n(n);const i=flarum.core.compat["forum/components/DiscussionsSearchSource"];var s=t.n(i);const a=flarum.core.compat["forum/components/DiscussionListItem"];var c=t.n(a);const u=flarum.core.compat["forum/components/CommentPost"];var l=t.n(u);function h(t,e){"object"==typeof t&&null!==t&&(Array.isArray(t)?t.forEach((function(t){return h(t,e)})):(e(t),Array.isArray(t.children)&&h(t.children,e)))}function f(t,e,r,n){var o=t.attribute(e+"_highlight_"+r);if(!o||!n)return o;var i=o.replace(/(<\/p>|<br\/?>)/g,"$1 ").replace(/<img\b[^>]*>/gi," "),s=(new DOMParser).parseFromString(i,"text/html").documentElement,a=[],c=!1;["blockquote","script","br"].forEach((function(t){s.querySelectorAll(t).forEach((function(t){return t.remove()}))})),["p","h1","h2","h3","h4","h5","h6"].forEach((function(t){s.querySelectorAll(t).forEach((function(e){var r=s.ownerDocument.createElement("span");0===t.indexOf("h")&&(r.className="title-in-excerpt"),r.innerHTML=e.innerHTML,e.parentNode.replaceChild(r,e)}))})),s.querySelector("body").childNodes.forEach((function(t){if(t instanceof HTMLElement){var e=t.innerText.length,r=null!==t.querySelector("mark");c||r&&(c=!0),a.push({node:t,textLength:e,hasMark:r})}}));var u=0;return a.forEach((function(t){0!==u||t.hasMark||!c?(u>n&&t.node.remove(),u+=t.textLength):t.node.remove()})),s.innerHTML}o().initializers.add("clarkwinkelmann-advanced-search-highlight",(function(){(0,r.extend)(s().prototype,"view",(function(t,e){t.forEach((function(t){var r=t&&t.attrs&&t.attrs["data-index"];if(r&&0===r.indexOf("discussions")){var n=o().store.getById("discussions",r.replace("discussions",""));n&&h(t,(function(t){var r=(t.attrs||{}).className;if("DiscussionSearchResult-title"===r){var o=f(n,"title",e);o&&(t.children=[m.trust(o)])}else if("DiscussionSearchResult-excerpt"===r){var i=n.mostRelevantPost(),s=i&&f(i,"contentHtml",e,100);s&&(t.children=[m.trust(s)])}}))}}))})),(0,r.extend)(c().prototype,"view",(function(t){var e=this,r=this.attrs.params.q;r&&h(t,(function(t){if("h2"===t.tag&&-1!==((t.attrs||{}).className||"").indexOf("DiscussionListItem-title")){var n=f(e.attrs.discussion,"title",r);n&&(t.children=[m.trust(n)])}}))})),(0,r.extend)(c().prototype,"infoItems",(function(t){var e=this.attrs.params.q;if(e&&t.has("excerpt")){var r=f(this.attrs.discussion.mostRelevantPost()||this.attrs.discussion.firstPost(),"contentHtml",e,175);r&&t.setContent("excerpt",m.trust(r))}})),(0,r.extend)(l().prototype,"oninit",(function(){this.subtree.check((function(){var t;return null==(t=o().current.get("stream"))?void 0:t.highlightPostSearch}))})),(0,r.extend)(l().prototype,"content",(function(t){var e,r=null==(e=o().current.get("stream"))?void 0:e.highlightPostSearch;if(r){var n=f(this.attrs.post,"contentHtml",r);n&&h(t,(function(t){"Post-body"===(t.attrs||{}).className&&(t.children=[m.trust(n)])}))}})),(0,r.override)(l().prototype,"refreshContent",(function(t){var e,r=null==(e=o().current.get("stream"))?void 0:e.highlightPostSearch;if(!r)return t();var n=f(this.attrs.post,"contentHtml",r);if(!n)return t();this.contentHtml!==n&&this.$(".Post-body script").each((function(){var t=document.createElement("script");t.textContent=this.textContent,Array.from(this.attributes).forEach((function(e){return t.setAttribute(e.name,e.value)})),this.parentNode.replaceChild(t,this)})),this.contentHtml=n}))}))})(),module.exports=e})();
//# sourceMappingURL=forum.js.map