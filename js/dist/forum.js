(()=>{var t={n:e=>{var r=e&&e.__esModule?()=>e.default:()=>e;return t.d(r,{a:r}),r},d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e)};(()=>{"use strict";const e=flarum.core.compat["common/extend"],r=flarum.core.compat["forum/app"];var n=t.n(r);const o=flarum.core.compat["forum/components/DiscussionsSearchSource"];var s=t.n(o);const i=flarum.core.compat["forum/components/DiscussionListItem"];var a=t.n(i);const c=flarum.core.compat["forum/components/CommentPost"];var u=t.n(c);function l(t,e){"object"==typeof t&&null!==t&&(Array.isArray(t)?t.forEach((function(t){return l(t,e)})):(e(t),Array.isArray(t.children)&&l(t.children,e)))}function h(t,e,r,n){var o=t.attribute(e+"_highlight_"+r);if(!o||!n)return o;var s=o.replace(/(<\/p>|<br\/?>)/g,"$1 ").replace(/<img\b[^>]*>/gi," "),i=(new DOMParser).parseFromString(s,"text/html").documentElement,a=[],c=!1;["blockquote","script","br"].forEach((function(t){i.querySelectorAll(t).forEach((function(t){return t.remove()}))})),["p","h1","h2","h3","h4","h5","h6"].forEach((function(t){i.querySelectorAll(t).forEach((function(e){var r=i.ownerDocument.createElement("span");0===t.indexOf("h")&&(r.className="title-in-excerpt"),r.innerHTML=e.innerHTML,e.parentNode.replaceChild(r,e)}))})),i.querySelector("body").childNodes.forEach((function(t){if(t instanceof HTMLElement){var e=t.innerText.length,r=null!==t.querySelector("mark");c||r&&(c=!0),a.push({node:t,textLength:e,hasMark:r})}}));var u=0;return a.forEach((function(t){0!==u||t.hasMark||!c?(u>n&&t.node.remove(),u+=t.textLength):t.node.remove()})),i.innerHTML}n().initializers.add("clarkwinkelmann-advanced-search-highlight",(function(){(0,e.extend)(s().prototype,"view",(function(t,e){t.forEach((function(t){var r=t&&t.attrs&&t.attrs["data-index"];if(r&&0===r.indexOf("discussions")){var o=n().store.getById("discussions",r.replace("discussions",""));o&&l(t,(function(t){var r=(t.attrs||{}).className;if("DiscussionSearchResult-title"===r){var n=h(o,"title",e);n&&(t.children=[m.trust(n)])}else if("DiscussionSearchResult-excerpt"===r){var s=o.mostRelevantPost(),i=s&&h(s,"contentHtml",e,100);i&&(t.children=[m.trust(i)])}}))}}))})),(0,e.extend)(a().prototype,"view",(function(t){var e=this,r=this.attrs.params.q;r&&l(t,(function(t){if("h2"===t.tag&&-1!==((t.attrs||{}).className||"").indexOf("DiscussionListItem-title")){var n=h(e.attrs.discussion,"title",r);n&&(t.children=[m.trust(n)])}}))})),(0,e.extend)(a().prototype,"infoItems",(function(t){var e=this.attrs.params.q;if(e&&t.has("excerpt")){var r=h(this.attrs.discussion.mostRelevantPost()||this.attrs.discussion.firstPost(),"contentHtml",e,175);r&&t.setContent("excerpt",m.trust(r))}})),(0,e.extend)(u().prototype,"oninit",(function(){this.subtree.check((function(){var t;return null==(t=n().current.get("stream"))?void 0:t.highlightPostSearch}))})),(0,e.extend)(u().prototype,"content",(function(t){var e,r=null==(e=n().current.get("stream"))?void 0:e.highlightPostSearch;if(r){var o=h(this.attrs.post,"contentHtml",r);o&&l(t,(function(t){"Post-body"===(t.attrs||{}).className&&(t.children=[m.trust(o)])}))}})),(0,e.override)(u().prototype,"refreshContent",(function(t){var e,r=null==(e=n().current.get("stream"))?void 0:e.highlightPostSearch;if(!r)return t();var o=h(this.attrs.post,"contentHtml",r);if(!o)return t();this.contentHtml!==o&&this.$(".Post-body script").each((function(){var t=document.createElement("script");t.textContent=this.textContent,Array.from(this.attributes).forEach((function(e){return t.setAttribute(e.name,e.value)})),this.parentNode.replaceChild(t,this)})),this.contentHtml=o}))}))})(),module.exports={}})();
//# sourceMappingURL=forum.js.map