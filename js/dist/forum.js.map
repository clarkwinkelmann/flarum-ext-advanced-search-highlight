{"version":3,"file":"forum.js","mappings":"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","sources":["webpack://@clarkwinkelmann/advanced-search-highlight/webpack/bootstrap","webpack://@clarkwinkelmann/advanced-search-highlight/webpack/runtime/compat get default export","webpack://@clarkwinkelmann/advanced-search-highlight/webpack/runtime/define property getters","webpack://@clarkwinkelmann/advanced-search-highlight/webpack/runtime/hasOwnProperty shorthand","webpack://@clarkwinkelmann/advanced-search-highlight/webpack/runtime/make namespace object","webpack://@clarkwinkelmann/advanced-search-highlight/external root \"flarum.core.compat['common/extend']\"","webpack://@clarkwinkelmann/advanced-search-highlight/external root \"flarum.core.compat['forum/app']\"","webpack://@clarkwinkelmann/advanced-search-highlight/external root \"flarum.core.compat['forum/components/DiscussionsSearchSource']\"","webpack://@clarkwinkelmann/advanced-search-highlight/external root \"flarum.core.compat['forum/components/DiscussionListItem']\"","webpack://@clarkwinkelmann/advanced-search-highlight/external root \"flarum.core.compat['forum/components/CommentPost']\"","webpack://@clarkwinkelmann/advanced-search-highlight/./src/forum/index.ts"],"sourcesContent":["// The require scope\nvar __webpack_require__ = {};\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","// define __esModule on exports\n__webpack_require__.r = (exports) => {\n\tif(typeof Symbol !== 'undefined' && Symbol.toStringTag) {\n\t\tObject.defineProperty(exports, Symbol.toStringTag, { value: 'Module' });\n\t}\n\tObject.defineProperty(exports, '__esModule', { value: true });\n};","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['common/extend'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/app'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionsSearchSource'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/DiscussionListItem'];","const __WEBPACK_NAMESPACE_OBJECT__ = flarum.core.compat['forum/components/CommentPost'];","import {Vnode, Children} from 'mithril';\nimport {extend, override} from 'flarum/common/extend';\nimport app from 'flarum/forum/app';\nimport DiscussionsSearchSource from 'flarum/forum/components/DiscussionsSearchSource';\nimport Model from 'flarum/common/Model';\nimport Discussion from 'flarum/common/models/Discussion';\nimport DiscussionListItem from 'flarum/forum/components/DiscussionListItem';\nimport CommentPost from 'flarum/forum/components/CommentPost';\n\nfunction walkVdom(node: Children, callback: (node: Vnode) => void) {\n    if (typeof node !== 'object' || node === null) {\n        return;\n    }\n\n    if (Array.isArray(node)) {\n        node.forEach(child => walkVdom(child, callback));\n        return;\n    }\n\n    callback(node);\n\n    if (Array.isArray(node.children)) {\n        walkVdom(node.children, callback)\n    }\n}\n\ninterface NodeInfo {\n    node: HTMLElement\n    textLength: number\n    hasMark: boolean\n}\n\nfunction highlightedResult(model: Model, attribute: string, query: string, length?: number): string | null | undefined {\n    const highlightedHtml = model.attribute<string>(attribute + '_highlight_' + query);\n\n    if (!highlightedHtml || !length) {\n        return highlightedHtml;\n    }\n\n    // Similar to getPlainContent(), we don't want excessive non-text content\n    // But unlike Flarum's native solution we are going to preserve most formatting since the backend already went the trouble of highlighting it\n    const html = highlightedHtml.replace(/(<\\/p>|<br\\/?>)/g, '$1 ').replace(/<img\\b[^>]*>/gi, ' ');\n\n    const element = new DOMParser().parseFromString(html, 'text/html').documentElement;\n\n    const rootNodes: NodeInfo[] = [];\n\n    let lengthUntilFirstMark = 0;\n    let foundFirstMark = false;\n\n    // Just like in Flarum's getPlainContent() we will remove quotes to save space\n    // We will also remove script tags but just to make sure they never execute\n    // Line breaks will be removed and the nbsp inserted above will take effect\n    ['blockquote', 'script', 'br'].forEach(selector => {\n        element.querySelectorAll(selector).forEach(node => node.remove());\n    });\n\n    // Replace paragraphs with spans to force everything to collapse to one line\n    // The nbsp inserted above will ensure some inline spacing remains\n    ['p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'].forEach(selector => {\n        element.querySelectorAll(selector).forEach(blockNode => {\n            const span = element.ownerDocument.createElement('span');\n\n            if (selector.indexOf('h') === 0) {\n                span.className = 'title-in-excerpt';\n            }\n\n            span.innerHTML = blockNode.innerHTML;\n\n            blockNode.parentNode!.replaceChild(span, blockNode);\n        });\n    });\n\n    element.querySelector('body')!.childNodes.forEach(node => {\n        if (!(node instanceof HTMLElement)) {\n            return;\n        }\n\n        const textLength = node.innerText.length\n        const hasMark = node.querySelector('mark') !== null;\n\n        if (!foundFirstMark) {\n            if (hasMark) {\n                foundFirstMark = true;\n            } else {\n                lengthUntilFirstMark += textLength;\n            }\n        }\n\n        rootNodes.push({\n            node,\n            textLength,\n            hasMark,\n        });\n    });\n\n    // TODO: if there's enough space between the first match and nothing interesting to show later in the string, we should show more of the start just like Flarum's highlight() method does\n\n    let outputtedLength = 0;\n\n    rootNodes.forEach(nodeInfo => {\n        // Skip nodes until we find the first with a mark, then we'll count the length from there\n        // If the mark was not found above, ignore this step and return content from the first node\n        if (outputtedLength === 0 && !nodeInfo.hasMark && foundFirstMark) {\n            nodeInfo.node.remove();\n            return;\n        }\n\n        if (outputtedLength > length) {\n            nodeInfo.node.remove();\n        }\n\n        outputtedLength += nodeInfo.textLength;\n    });\n\n    return element.innerHTML;\n}\n\napp.initializers.add('clarkwinkelmann-advanced-search-highlight', () => {\n    extend(DiscussionsSearchSource.prototype, 'view', function (dom, query) {\n        dom.forEach(node => {\n            const index = node && node.attrs && node.attrs['data-index'];\n\n            if (!index || index.indexOf('discussions') !== 0) {\n                return;\n            }\n\n            const discussion = app.store.getById<Discussion>('discussions', index.replace('discussions', ''));\n\n            if (!discussion) {\n                return;\n            }\n\n            walkVdom(node, child => {\n                const {className} = child.attrs as any || {};\n\n                if (className === 'DiscussionSearchResult-title') {\n                    const highlight = highlightedResult(discussion, 'title', query);\n\n                    if (highlight) {\n                        child.children = [\n                            m.trust(highlight),\n                        ];\n                    }\n                } else if (className === 'DiscussionSearchResult-excerpt') {\n                    const mostRelevantPost = discussion.mostRelevantPost();\n                    const highlight = mostRelevantPost && highlightedResult(mostRelevantPost, 'contentHtml', query, 100);\n\n                    if (highlight) {\n                        child.children = [\n                            m.trust(highlight),\n                        ];\n                    }\n                }\n            });\n        });\n    });\n\n    extend(DiscussionListItem.prototype, 'view', function (dom) {\n        const {q} = this.attrs.params;\n\n        if (!q) {\n            return;\n        }\n\n        walkVdom(dom, node => {\n            if (node.tag === 'h2' && ((node.attrs as any || {}).className || '').indexOf('DiscussionListItem-title') !== -1) {\n                const highlight = highlightedResult(this.attrs.discussion, 'title', q);\n\n                if (highlight) {\n                    node.children = [\n                        m.trust(highlight),\n                    ];\n                }\n            }\n        });\n    });\n\n    extend(DiscussionListItem.prototype, 'infoItems', function (items) {\n        const {q} = this.attrs.params;\n\n        if (!q || !items.has('excerpt')) {\n            return;\n        }\n\n        const post = this.attrs.discussion.mostRelevantPost() || this.attrs.discussion.firstPost();\n\n        const highlight = highlightedResult(post, 'contentHtml', q, 175);\n\n        if (highlight) {\n            items.setContent('excerpt', m.trust(highlight));\n        }\n    });\n\n    extend(CommentPost.prototype, 'oninit', function () {\n        this.subtree.check(() => app.current.get('stream').highlightPostSearch);\n    });\n\n    extend(CommentPost.prototype, 'content', function (dom) {\n        const query = app.current.get('stream').highlightPostSearch;\n\n        if (!query) {\n            return;\n        }\n\n        const contentHtml = highlightedResult(this.attrs.post, 'contentHtml', query);\n\n        if (!contentHtml) {\n            return;\n        }\n\n        walkVdom(dom, child => {\n            if ((child.attrs as any || {}).className === 'Post-body') {\n                child.children = [\n                    m.trust(contentHtml),\n                ];\n            }\n        });\n    });\n\n    override(CommentPost.prototype, 'refreshContent', function (original) {\n        const query = app.current.get('stream').highlightPostSearch;\n\n        if (!query) {\n            return original();\n        }\n\n        const contentHtml = highlightedResult(this.attrs.post, 'contentHtml', query);\n\n        if (!contentHtml) {\n            return original();\n        }\n\n        // Same as original code, but we repeat it for when the original contentHtml is switched with the highlighted content\n        if (this.contentHtml !== contentHtml) {\n            this.$('.Post-body script').each(function () {\n                const script = document.createElement('script');\n                script.textContent = this.textContent;\n                Array.from(this.attributes).forEach((attr) => script.setAttribute(attr.name, attr.value));\n                this.parentNode!.replaceChild(script, this);\n            });\n        }\n\n        this.contentHtml = contentHtml;\n    });\n});\n"],"names":["__webpack_require__","module","getter","__esModule","d","a","exports","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","Symbol","toStringTag","value","flarum","core","compat","walkVdom","node","callback","Array","isArray","forEach","child","children","highlightedResult","model","attribute","query","length","highlightedHtml","html","replace","element","DOMParser","parseFromString","documentElement","rootNodes","foundFirstMark","selector","querySelectorAll","remove","blockNode","span","ownerDocument","createElement","indexOf","className","innerHTML","parentNode","replaceChild","querySelector","childNodes","HTMLElement","textLength","innerText","hasMark","push","outputtedLength","nodeInfo","app","extend","DiscussionsSearchSource","dom","index","attrs","discussion","highlight","m","trust","mostRelevantPost","DiscussionListItem","_this","q","this","params","tag","items","has","firstPost","setContent","CommentPost","subtree","check","highlightPostSearch","contentHtml","post","override","original","$","each","script","document","textContent","from","attributes","attr","setAttribute","name"],"sourceRoot":""}